/*
 * @license Copyright (c) 2021, Venus All Rights Reserved.
 * Available via the MIT license.
 */
const e=window;function t(t){const r=e.devicePixelRatio,E=e.innerWidth,a=e.innerHeight;t.width=E*r,t.height=a*r,t.style.setProperty("width",E+"px"),t.style.setProperty("height",a+"px")}function r(e){return"KEEP"===(e=e.toUpperCase())||"ZERO"===e||"REPLACE"===e||"INCR"===e||"DECR"===e||"INVERT"===e||"INCR_WRAP"===e||"DECR_WRAP"===e}function E(e,t){return null==e?t:e}E.EMPTY_OBJECT=Object.freeze({});const a=window;function n(e){return null!=e}const T={36053:"FRAMEBUFFER_COMPLETE",36054:"FRAMEBUFFER_INCOMPLETE_ATTACHMENT",36055:"FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT",36057:"FRAMEBUFFER_INCOMPLETE_DIMENSIONS",36061:"FRAMEBUFFER_UNSUPPORTED"};function i(e){return 0==(e&e-1)}const o={},R={},_={};function c(e){const{name:t,size:r,type:E}=e;let a=0;switch(E){case 5126:a=1*r;break;case 35664:a=2*r;break;case 35665:a=3*r;break;case 35666:case 35674:a=4*r;break;case 35675:a=9*r;break;case 35676:a=16*r;break;default:console.warn("无法识别 attribute "+t+" 的类型："+E)}return a}function s(e,t,r){const a=e.createBuffer();return r=E(r,e.STATIC_DRAW),e.bindBuffer(e.ARRAY_BUFFER,a),e.bufferData(e.ARRAY_BUFFER,t,r),a}const f={createContext:function(e){e=E(e,E.EMPTY_OBJECT);const r=a.document.createElement("canvas");let n;return n=e.requireWebgl2?r.getContext("webgl2",e):r.getContext("webgl",e),r.style.setProperty("display","block"),t(n.canvas),n},setState:function(e,t){const{depthTest:E,stencilTest:a,colorMask:T,cull:i,blend:o,viewport:R,scissor:_}=t;if(i){i.enable?e.enable(e.CULL_FACE):e.disable(e.CULL_FACE);let t=i.face&&i.face.toUpperCase();!t||"BACK"!==t&&"FRONT"!==t&&"FRONT_AND_BACK"!==t||e.cullFace(e[t])}if(E){if(!0===E.enable?e.enable(e.DEPTH_TEST):!1===E.enable&&e.disable(e.DEPTH_TEST),E.func){const t=E.func.toUpperCase();e.depthFunc(e[t])}!0===E.write?e.depthMask(!0):!1===E.write&&e.depthMask(!1)}if(a){if(!0===a.enable?e.enable(e.STENCIL_TEST):!1===a.enable&&e.disable(e.STENCIL_TEST),n(a.writeMask)&&e.stencilMask(a.writeMask),n(a.func)&&n(a.ref)&&n(a.readMask)){if(!1===function(e){return"NEVER"===(e=e.toUpperCase())||"ALWAYS"===e||"LESS"===e||"LEQUAL"===e||"NOTEQUAL"===e||"EQUAL"===e||"GREATER"===e||"GEQUAL"===e}(a.func))throw new Error("setState: stencil func is invalid, current is "+a.func+"!");const t=a.func.toUpperCase();e.stencilFunc(e[t],a.ref,a.readMask)}if(n(a.fail)&&n(a.zfail)&&n(a.zpass)){if(!1===r(a.fail)||!1===r(a.zfail)||!1===r(a.zpass))throw new Error("setState: stencil op is invalid!");const t=a.fail.toUpperCase(),E=a.zfail.toUpperCase(),n=a.zpass.toUpperCase();e.stencilOp(e[t],e[E],e[n])}}if(T&&e.colorMask(T[0],T[1],T[2],T[3]),o&&(!0===o.enable?e.enable(e.BLEND):!1===o.enable&&e.disable(e.BLEND),o.blendColor&&e.blendColor(...o.blendColor),o.blendEquation&&e.blendEquation(e[o.blendEquation.toUpperCase()]),o.blendFunc)){const t=o.blendFunc[0].toUpperCase(),r=o.blendFunc[1].toUpperCase();e.blendFunc(e[t],e[r])}if(R&&e.viewport(R[0],R[1],R[2],R[3]),_){!0===_.enable?e.enable(e.SCISSOR_TEST):!1===_.enable&&e.disable(e.SCISSOR_TEST);const t=_.rect;t&&e.scissor(t[0],t[1],t[2],t[3])}},clear:function(e,t){t=E(t,E.EMPTY_OBJECT);const{fb:r,color:a,depth:T,stencil:i}=t;e.bindFramebuffer(e.FRAMEBUFFER,r);let o=0;a&&(e.clearColor(a[0],a[1],a[2],a[3]),o|=e.COLOR_BUFFER_BIT),n(T)&&(e.clearDepth(T),o|=e.DEPTH_BUFFER_BIT),i&&(e.clearStencil(i),o|=e.STENCIL_BUFFER_BIT),0!==o&&e.clear(o)},draw:function(e,r){const{attributes:a,indices:n,vs:T,fs:f,count:A,fb:U}=r,l=E(r.primitiveType,e.TRIANGLES),u=E(r.uniforms,E.EMPTY_OBJECT);e.bindFramebuffer(e.FRAMEBUFFER,U);const d=T+f;let F=o[d];F||(F=function(e,t,r){const E=e.createShader(e.VERTEX_SHADER);e.shaderSource(E,t),e.compileShader(E);const a=e.createShader(e.FRAGMENT_SHADER);e.shaderSource(a,r),e.compileShader(a);const n=e.createProgram();e.attachShader(n,E),e.attachShader(n,a),e.deleteShader(E),e.deleteShader(a),e.linkProgram(n);let T="";if(!e.getProgramParameter(n,e.LINK_STATUS))throw e.getShaderParameter(a,e.COMPILE_STATUS)||(T=e.getShaderInfoLog(a),console.error("Fragment shader failed to compiled: "+T)),e.getShaderParameter(E,e.COMPILE_STATUS)||(T=e.getShaderInfoLog(E),console.error("Vertex shader failed to compiled: "+T)),T=e.getProgramInfoLog(n),console.error("Shader program link log: "+T),new Error(info);return n}(e,T,f),o[d]=F),e.useProgram(F),t(e.canvas);const P=e.getProgramParameter(F,e.ACTIVE_ATTRIBUTES);for(let t=0;t<P;t++){const r=e.getActiveAttrib(F,t),E=r.name;if(Object.hasOwnProperty.call(a,E)){const t=a[E],n=e.getAttribLocation(F,E);if(-1===n)continue;const T=t.toString();let i=R[T];const o=c(r);if(Array.isArray(t)){const r=Float32Array;i||(i=s(e,new r(t)),R[T]=i),e.bindBuffer(e.ARRAY_BUFFER,i),e.enableVertexAttribArray(n),e.vertexAttribPointer(n,o,e.FLOAT,!1,0,0)}else((b=t)instanceof Float32Array||b instanceof Uint8Array||b instanceof Uint16Array||b instanceof Uint32Array||b instanceof Int8Array||b instanceof Int16Array||b instanceof Int32Array)&&(i||(i=s(e,t),R[T]=i),e.bindBuffer(e.ARRAY_BUFFER,i),e.enableVertexAttribArray(n),e.vertexAttribPointer(n,o,e.FLOAT,!1,0,0))}}var b;const M=e.getProgramParameter(F,e.ACTIVE_UNIFORMS),m=e.getParameter(e.MAX_TEXTURE_IMAGE_UNITS);let I=0;for(let t=0;t<M;t++){const r=e.getActiveUniform(F,t),E=r.name;if(Object.hasOwnProperty.call(u,E)){const t=u[E],a=e.getUniformLocation(F,E);if(null===a)continue;const n=typeof t,T=e.TEXTURE0+I;if(t instanceof WebGLTexture){if(e.activeTexture(T),r.type===e.SAMPLER_2D)e.bindTexture(e.TEXTURE_2D,t);else{if(r.type!==e.SAMPLER_CUBE)throw new Error(r,"type MUST be SAMPLER_2D or SAMPLER_CUBE");e.bindTexture(e.TEXTURE_CUBE_MAP,t)}e.uniform1i(a,I),I++}else if(S=t,Array.isArray(S)||S&&"object"==typeof S&&"number"==typeof S.length&&(0===S.length||S.length>0&&S.length-1 in S)){const r=t.length;if(r<=4)e["uniform"+r+"fv"](a,t);else if(r<=16){const E=Math.floor(Math.sqrt(r)),n=!1;e["uniformMatrix"+E+"fv"](a,n,Array.from(t))}}else if("number"===n)e.uniform1f(a,t);else if("string"===n){if(I>m){console.error("texture exceed maximum texture units.");continue}let r=_[t];if(!r){r=e.createTexture(),e.activeTexture(T),e.bindTexture(e.TEXTURE_2D,r),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,1,1,0,e.RGBA,e.UNSIGNED_BYTE,new Uint8Array([255,255,255,255]));const E=new Image;E.src=t,E.addEventListener("load",(()=>{e.activeTexture(T),e.bindTexture(e.TEXTURE_2D,r),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,E),i(E.width)&&i(E.height)&&(e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.REPEAT),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.REPEAT),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR_MIPMAP_LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.generateMipmap(e.TEXTURE_2D))})),_[t]=r}e.activeTexture(T),e.bindTexture(e.TEXTURE_2D,r),e.uniform1i(a,I),I++}}}var S;if(n&&n.length>0){let t,r,a=Number.MIN_SAFE_INTEGER;for(const e of n)a=Math.max(e,a);a<=255?(t=e.UNSIGNED_BYTE,r=Uint8Array):a<=65535?(t=e.UNSIGNED_SHORT,r=Uint16Array):(t=e.UNSIGNED_INT,r=Uint32Array,e.getExtension("OES_element_index_unit"));const T=n.toString();let i=R[T];i||(i=function(e,t,r){const a=e.createBuffer();return r=E(r,e.STATIC_DRAW),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,a),e.bufferData(e.ELEMENT_ARRAY_BUFFER,t,r),a}(e,new r(n)),R[T]=i),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,i),e.drawElements(l,A,t,0)}else e.drawArrays(l,0,A)},createTexture:function(e,t){const{level:r,internalFormat:E,type:a,format:T,width:o,height:R,data:_,wrapS:c,wrapT:s,minFilter:f,magFilter:A,generateMipmap:U}=t,l=e.createTexture();return e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,l),e.texImage2D(e.TEXTURE_2D,r,E,o,R,0,T,a,_),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),n(c)&&e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,c),n(s)&&e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,s),n(f)&&e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,f),n(A)&&e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,A),!0===U&&(i(o)&&i(R)?e.generateMipmap(e.TEXTURE_2D):console.warn("createTexture: texture size is NOT power of two, current is "+o+"x"+R+".")),l},createCubeMap:function(e,t){t=E(t,E.EMPTY_OBJECT);const r=E(t.level,0),a=t.data,n=t.width,T=t.height,i=E(t.format,e.RGBA),o=E(t.type,e.UNSIGNED_BYTE),R=E(t.internalFormat,e.RGBA),_=e.createTexture();e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_CUBE_MAP,_);const c=[{target:e.TEXTURE_CUBE_MAP_POSITIVE_X,data:a.px},{target:e.TEXTURE_CUBE_MAP_NEGATIVE_X,data:a.nx},{target:e.TEXTURE_CUBE_MAP_POSITIVE_Y,data:a.py},{target:e.TEXTURE_CUBE_MAP_NEGATIVE_Y,data:a.ny},{target:e.TEXTURE_CUBE_MAP_POSITIVE_Z,data:a.pz},{target:e.TEXTURE_CUBE_MAP_NEGATIVE_Z,data:a.nz}];for(let t=0;t<6;t++){const E=c[t],a=E.target,_=E.data;_ instanceof HTMLImageElement?e.texImage2D(a,r,R,i,o,_):e.texImage2D(a,r,R,n,T,0,i,o,_),e.texParameteri(e.TEXTURE_CUBE_MAP,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_CUBE_MAP,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_CUBE_MAP,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_CUBE_MAP,e.TEXTURE_MAG_FILTER,e.LINEAR)}return _},createFramebuffer:function(e,t){const{colorTexture:r,depthTexture:E,depthRenderbuffer:a}=t,n=e.createFramebuffer();if(e.bindFramebuffer(e.FRAMEBUFFER,n),e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,r),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,r,0),E)e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,E),e.framebufferTexture2D(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,e.TEXTURE_2D,E,0);else if(a){const t=e.createRenderbuffer();e.bindRenderbuffer(e.RENDERBUFFER,t),e.renderbufferStorage(e.RENDERBUFFER,e.DEPTH_COMPONENT16,a.width,a.height),e.framebufferRenderbuffer(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,e.RENDERBUFFER,t)}const i=e.checkFramebufferStatus(e.FRAMEBUFFER);if(i!==e.FRAMEBUFFER_COMPLETE)throw new Error("createFramebuffer: framebuffer combination is NOT completed! Current status is "+T[i]+".");return n}};export default f;
