<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Multisample</title>
  <script src="../../dist/toygl.js"></script>
  <script src="../ThirdParty/tweakpane-3.0.7.js"></script>
  <style>html, body { margin: 0; }</style>
</head>
<body>
  <script>
    const gl = ToyGL.createContext({
      requireWebgl2: true,
      antialias: false,
    });
    document.body.appendChild(gl.canvas);

    const drawVS = `
      attribute vec2 a_position;
      void main() {
        gl_Position = vec4(a_position, 0, 1);
      }
    `;
    const drawFS = `
      precision highp float;
      void main() {
        gl_FragColor = vec4(1);
      }
    `;
    const blitVS = `#version 300 es
      precision highp float;
      in vec2 a_pos;
      out vec2 v_uv;
      void main() {
        gl_Position = vec4(a_pos, 0, 1);
        v_uv = a_pos * 0.5 + vec2(0.5);
      }
    `;
    const blitFS = `#version 300 es
      precision highp float;
      in vec2 v_uv;
      uniform sampler2D u_texture;
      out vec4 fragColor;
      void main() {
        fragColor = texture(u_texture, v_uv);
      }
    `;

    const thinTriangle = [
      -0.6, 0.0,
      0.6, 0.1,
      0.6, 0.105,
    ];

    const width = gl.drawingBufferWidth;
    const height = gl.drawingBufferHeight;

    let multisampleFramebuffer, colorBufferTexture, colorBufferFramebuffer;
    function initResource() {
      multisampleFramebuffer = gl.createFramebuffer();
      const multisampleRenderbuffer = gl.createRenderbuffer();

      function updateSamples(samples) {
        gl.bindRenderbuffer(gl.RENDERBUFFER, multisampleRenderbuffer);
        gl.renderbufferStorageMultisample(gl.RENDERBUFFER, samples, gl.RGBA8, width, height);
        gl.bindRenderbuffer(gl.RENDERBUFFER, null);

        gl.bindFramebuffer(gl.FRAMEBUFFER, multisampleFramebuffer);
        gl.framebufferRenderbuffer(gl.FRAMEBUFFER, gl.COLOR_ATTACHMENT0, gl.RENDERBUFFER, multisampleRenderbuffer);
        gl.bindFramebuffer(gl.FRAMEBUFFER, null);
      }

      const samplesOptions = {};
      gl.bindRenderbuffer(gl.RENDERBUFFER, multisampleRenderbuffer);
      gl.getInternalformatParameter(gl.RENDERBUFFER, gl.RGBA8, gl.SAMPLES)
        .forEach(samples => {
          samplesOptions[samples.toString()] = samples;
        });

      const param = {
        samples: 1,
      };
      const pane = new Tweakpane.Pane();
      pane.addInput(param, 'samples', {
        options: samplesOptions,
      }).on('change', e => {
        const samples = e.value;
        updateSamples(samples);
      });
      updateSamples(param.samples);

      colorBufferTexture = gl.createTexture();
      gl.activeTexture(gl.TEXTURE0);
      gl.bindTexture(gl.TEXTURE_2D, colorBufferTexture);
      gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA8, width, height, 0, gl.RGBA, gl.UNSIGNED_BYTE, null);
      gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.NEAREST);
      gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.NEAREST);
      gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);
      gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);
      gl.bindTexture(gl.TEXTURE_2D, null);

      colorBufferFramebuffer = gl.createFramebuffer();
      gl.bindFramebuffer(gl.FRAMEBUFFER, colorBufferFramebuffer);
      gl.framebufferTexture2D(gl.FRAMEBUFFER, gl.COLOR_ATTACHMENT0, gl.TEXTURE_2D, colorBufferTexture, 0);
      gl.bindFramebuffer(gl.FRAMEBUFFER, null);
    }

    function render() {
      requestAnimationFrame(render);

      ToyGL.setState(gl, {
        viewport: [0, 0, gl.drawingBufferWidth, gl.drawingBufferHeight],
      });

      ToyGL.clear(gl, {
        color: [0, 0, 0, 1],
        fb: multisampleFramebuffer,
      });

      ToyGL.draw(gl, {
        vs: drawVS,
        fs: drawFS,
        attributes: {
          a_position: thinTriangle,
        },
        count: 3,
        fb: multisampleFramebuffer,
      });

      {
        gl.bindFramebuffer(gl.READ_FRAMEBUFFER, multisampleFramebuffer);
        gl.bindFramebuffer(gl.DRAW_FRAMEBUFFER, colorBufferFramebuffer);
        gl.blitFramebuffer(
          0, 0, width, height,
          0, 0, width, height,
          gl.COLOR_BUFFER_BIT, gl.NEAREST
        );
        gl.bindFramebuffer(gl.FRAMEBUFFER, null);
      }

      ToyGL.draw(gl, {
        vs: blitVS,
        fs: blitFS,
        attributes: {
          a_pos: [
            -1, -1,
            3, -1,
            -1,  3,
          ]
        },
        uniforms: {
          u_texture: colorBufferTexture,
        },
        count: 3,
        fb: null,
      });
    }

    initResource();
    requestAnimationFrame(render);
  </script>
</body>
</html>